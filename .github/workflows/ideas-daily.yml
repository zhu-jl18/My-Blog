name: 📚 Ideas Daily JSON

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Target branch to push (default: current)"
        required: false
        default: ""

permissions:
  contents: write

jobs:
  build-daily:
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: 📦 Install dependencies
        run: |
          npm ci --prefer-offline --no-audit --no-fund

      - name: 🛠️ Build ideas_daily.json
        run: |
          node scripts/build-ideas-daily.mjs

      - name: ✅ Commit & Push if changed
        env:
          TARGET_BRANCH: ${{ github.event.inputs.branch }}
        run: |
          CHANGED=0
          if ! git diff --quiet -- source/ideas/ideas_daily.json; then
            CHANGED=1
            git config user.name "${GITHUB_ACTOR}"
            git config user.email "${GITHUB_ACTOR}@users.noreply.github.com"
            git add source/ideas/ideas_daily.json
            git commit -m "chore(ideas): update ideas_daily.json [skip ci]"
            BRANCH=${TARGET_BRANCH}
            if [ -z "$BRANCH" ]; then BRANCH="${GITHUB_REF_NAME}"; fi
            git push origin HEAD:$BRANCH
          fi
          echo "changed=$CHANGED" >> $GITHUB_OUTPUT
