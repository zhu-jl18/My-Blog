name: ðŸš€ è‡ªåŠ¨éƒ¨ç½²åˆ° GitHub Pages

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]
    paths:
      - 'source/**'           # åªåœ¨å†…å®¹å˜æ›´æ—¶è§¦å‘
      - '_config.yml'
      - '_config.next.yml'
      - 'package.json'
      - '.github/workflows/**' # æ·»åŠ å·¥ä½œæµæ–‡ä»¶å˜æ›´
      - 'themes/**'           # ä¸»é¢˜æ–‡ä»¶å˜æ›´
  pull_request:
    branches: [ main ]

# å·¥ä½œæµæƒé™
permissions:
  contents: read
  pages: write
  id-token: write

# å¹¶å‘æŽ§åˆ¶ï¼šåŒæ—¶åªå…è®¸ä¸€ä¸ªéƒ¨ç½²
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # æž„å»ºä»»åŠ¡
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´gitåŽ†å²
        submodules: true  # æ£€å‡ºå­æ¨¡å—ï¼ˆä¸»é¢˜ï¼‰
        
    - name: ðŸ”§ è®¾ç½® Node.js çŽ¯å¢ƒ  
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # ä½¿ç”¨æ›´ç¨³å®šçš„ Node.js ç‰ˆæœ¬
        cache: 'npm'  # è‡ªåŠ¨ç¼“å­˜npmä¾èµ–
        
    - name: ðŸ“¦ å®‰è£…ä¾èµ–
      run: |
        npm ci --prefer-offline --no-audit --no-fund
        npm list --depth=0
        
    - name: ðŸ—ï¸ æž„å»ºé™æ€æ–‡ä»¶
      run: |
        export NODE_ENV=production
        export NODE_OPTIONS="--max-old-space-size=4096"
        npm run clean
        npm run build
        
    - name: ðŸ” éªŒè¯æž„å»ºç»“æžœ
      run: |
        ls -la public/
        echo "ðŸ“Š æž„å»ºç»Ÿè®¡ï¼š"
        find public -name "*.html" | wc -l | xargs echo "HTMLæ–‡ä»¶æ•°ï¼š"
        find public -name "*.css" | wc -l | xargs echo "CSSæ–‡ä»¶æ•°ï¼š"
        find public -name "*.js" | wc -l | xargs echo "JSæ–‡ä»¶æ•°ï¼š"
        du -sh public/ | xargs echo "æ€»å¤§å°ï¼š"
        
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./public

  # éƒ¨ç½²ä»»åŠ¡ï¼ˆä»…åœ¨mainåˆ†æ”¯ï¼‰
  deploy:
    if: github.ref == 'refs/heads/main'
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²æˆåŠŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- â° æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”— è®¿é—®é“¾æŽ¥: ${{ steps.deployment.outputs.page_url }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ‘¤ æäº¤ä½œè€…: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ çŽ¯å¢ƒ: ${{ github.environment }}" >> $GITHUB_STEP_SUMMARY