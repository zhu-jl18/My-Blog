name: 🚀 构建并部署到 GitHub Pages

# 触发条件：推送到main分支时
on:
  push:
    branches: [ main ]
    paths:
      - 'source/**'           # 只在内容变更时触发
      - 'tools/**'            # 索引构建脚本变更也触发
      - '_config.yml'
      - '_config.next.yml'
      - 'package.json'
      - '.github/workflows/**' # 添加工作流文件变更
      - 'themes/**'           # 主题文件变更
  pull_request:
    branches: [ main ]

# 工作流权限
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # 构建和部署任务
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 检出源代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整git历史
        submodules: true  # 检出子模块（主题）
        
    - name: 🔧 设置 Node.js 环境  
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # 使用更稳定的 Node.js 版本
        cache: 'npm'  # 自动缓存npm依赖
        
    - name: 安装依赖
      run: |
        npm ci --prefer-offline --no-audit --no-fund
        npm list --depth=0
        

    - name: 🔧 注入配置文件
      run: |
        # 从模板生成配置文件，注入密钥
        sed "s/{{CHAT_API_KEY}}/${{ secrets.CHAT_API_KEY }}/g; s/{{SITE_DOMAIN}}/zhu-jl18.github.io/g" source/js/chat-config.template.json > source/js/chat-config.json
        echo "✅ 配置文件已生成"
        
    - name: 构建静态文件
      run: |
        export NODE_ENV=production
        export NODE_OPTIONS="--max-old-space-size=4096"
        npm run clean
        npm run build
        
    - name: 🔍 验证构建结果
      run: |
        ls -la public/
        echo "📊 构建统计："
        find public -name "*.html" | wc -l | xargs echo "HTML文件数："
        find public -name "*.css" | wc -l | xargs echo "CSS文件数："
        find public -name "*.js" | wc -l | xargs echo "JS文件数："
        du -sh public/ | xargs echo "总大小："
        
    - name: 🚀 部署到 GitHub Pages 仓库
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.PERSONAL_TOKEN }}
        external_repository: zhu-jl18/zhu-jl18.github.io
        publish_branch: main
        publish_dir: ./public
        user_name: github-actions[bot]
        user_email: github-actions[bot]@users.noreply.github.com
        commit_message: ${{ github.event.head_commit.message }} (Deployed from My-Blog)
        
    - name: 📊 生成部署报告
      if: github.ref == 'refs/heads/main'
      run: |
        echo "## 🎉 部署成功报告" >> $GITHUB_STEP_SUMMARY
        echo "- ⏰ 构建时间: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- 📝 提交信息: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "- 👤 提交作者: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- 🌐 博客地址: https://zhu-jl18.github.io" >> $GITHUB_STEP_SUMMARY