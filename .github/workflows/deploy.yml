name: ðŸš€ æž„å»ºå¹¶éƒ¨ç½²åˆ° GitHub Pages

# è§¦å‘æ¡ä»¶ï¼šæŽ¨é€åˆ°mainåˆ†æ”¯æ—¶
on:
  push:
    branches: [ main ]
    paths:
      - 'source/**'           # åªåœ¨å†…å®¹å˜æ›´æ—¶è§¦å‘
      - 'tools/**'            # ç´¢å¼•æž„å»ºè„šæœ¬å˜æ›´ä¹Ÿè§¦å‘
      - '_config.yml'
      - '_config.next.yml'
      - 'package.json'
      - '.github/workflows/**' # æ·»åŠ å·¥ä½œæµæ–‡ä»¶å˜æ›´
      - 'themes/**'           # ä¸»é¢˜æ–‡ä»¶å˜æ›´
  pull_request:
    branches: [ main ]

# å·¥ä½œæµæƒé™
permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # æž„å»ºå’Œéƒ¨ç½²ä»»åŠ¡
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºæºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # èŽ·å–å®Œæ•´gitåŽ†å²
        submodules: true  # æ£€å‡ºå­æ¨¡å—ï¼ˆä¸»é¢˜ï¼‰
        
    - name: ðŸ”§ è®¾ç½® Node.js çŽ¯å¢ƒ  
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # ä½¿ç”¨æ›´ç¨³å®šçš„ Node.js ç‰ˆæœ¬
        cache: 'npm'  # è‡ªåŠ¨ç¼“å­˜npmä¾èµ–
        
    - name: å®‰è£…ä¾èµ–
      run: |
        npm ci --prefer-offline --no-audit --no-fund
        npm list --depth=0
        

    - name: ðŸ”§ æ³¨å…¥é…ç½®æ–‡ä»¶
      run: |
        # ä»Žæ¨¡æ¿ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œæ³¨å…¥å¯†é’¥
        sed "s/{{CHAT_API_KEY}}/${{ secrets.CHAT_API_KEY }}/g; s/{{SITE_DOMAIN}}/zhu-jl18.github.io/g" source/js/chat-config.template.json > source/js/chat-config.json
        echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ"
        
    - name: æž„å»ºé™æ€æ–‡ä»¶
      run: |
        export NODE_ENV=production
        export NODE_OPTIONS="--max-old-space-size=4096"
        npm run clean
        npm run build
        
    - name: ðŸ” éªŒè¯æž„å»ºç»“æžœ
      run: |
        ls -la public/
        echo "ðŸ“Š æž„å»ºç»Ÿè®¡ï¼š"
        find public -name "*.html" | wc -l | xargs echo "HTMLæ–‡ä»¶æ•°ï¼š"
        find public -name "*.css" | wc -l | xargs echo "CSSæ–‡ä»¶æ•°ï¼š"
        find public -name "*.js" | wc -l | xargs echo "JSæ–‡ä»¶æ•°ï¼š"
        du -sh public/ | xargs echo "æ€»å¤§å°ï¼š"
        
    - name: ðŸš€ éƒ¨ç½²åˆ° GitHub Pages ä»“åº“
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.PERSONAL_TOKEN }}
        external_repository: zhu-jl18/zhu-jl18.github.io
        publish_branch: main
        publish_dir: ./public
        user_name: github-actions[bot]
        user_email: github-actions[bot]@users.noreply.github.com
        commit_message: ${{ github.event.head_commit.message }} (Deployed from My-Blog)
        
    - name: ðŸ“Š ç”Ÿæˆéƒ¨ç½²æŠ¥å‘Š
      if: github.ref == 'refs/heads/main'
      run: |
        echo "## ðŸŽ‰ éƒ¨ç½²æˆåŠŸæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- â° æž„å»ºæ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ‘¤ æäº¤ä½œè€…: ${{ github.event.head_commit.author.name }}" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ åšå®¢åœ°å€: https://zhu-jl18.github.io" >> $GITHUB_STEP_SUMMARY