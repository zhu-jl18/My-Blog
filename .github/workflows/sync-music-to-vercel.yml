name: ðŸŽµ åŒæ­¥éŸ³ä¹æ–‡ä»¶åˆ° Vercel

# å½“ music æ–‡ä»¶å¤¹æœ‰å˜åŒ–æ—¶è§¦å‘
on:
  push:
    paths:
      - 'music/**'
    branches: [main]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-to-vercel:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡º cdn4blog ä»“åº“
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ðŸ”§ é…ç½® Git
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: ðŸ“¥ æ£€å‡º Vercel ä»“åº“ï¼ˆé€šè¿‡ GitHub å†…å®¹ APIï¼‰
      uses: actions/checkout@v4
      with:
        repository: zhu-jl18/cdn4blog
        token: ${{ secrets.GITHUB_TOKEN }}
        path: 'temp-vercel'
        
    - name: ðŸ”„ åŒæ­¥éŸ³ä¹æ–‡ä»¶åˆ° Vercel
      env:
        VERCEL_DEPLOY_HOOK_URL: ${{ secrets.VERCEL_DEPLOY_HOOK_URL }}
      run: |
        # ç”±äºŽ Vercel å’Œ GitHub æ˜¯åŒä¸€ä¸ªä»“åº“ï¼Œæˆ‘ä»¬ç›´æŽ¥æäº¤å³å¯
        # Vercel ä¼šè‡ªåŠ¨æ£€æµ‹ GitHub ä»“åº“çš„æ›´æ–°
        
        # æ£€æŸ¥ music æ–‡ä»¶å¤¹æ˜¯å¦æœ‰æ–°å†…å®¹
        if [ -d "music" ] && [ "$(ls -A music)" ]; then
          echo "ðŸŽµ å‘çŽ°éŸ³ä¹æ–‡ä»¶ï¼Œå‡†å¤‡åŒæ­¥..."
          
          # æäº¤éŸ³ä¹æ–‡ä»¶
          git add music/
          if git diff --staged --quiet; then
            echo "â„¹ï¸ æ²¡æœ‰æ–°çš„éŸ³ä¹æ–‡ä»¶éœ€è¦æäº¤"
          else
            git commit -m "ðŸŽµ æ›´æ–°éŸ³ä¹æ–‡ä»¶
            
            ðŸ“ æ›´æ–°çš„æ–‡ä»¶ï¼š
            $(git diff --staged --name-only | sed 's/^/  - /')
            
            ðŸ¤– è‡ªåŠ¨åŒæ­¥äºŽ $(date '+%Y-%m-%d %H:%M:%S')
            "
            git push origin main
            
            echo "âœ… éŸ³ä¹æ–‡ä»¶å·²æŽ¨é€åˆ° GitHubï¼ŒVercel ä¼šè‡ªåŠ¨éƒ¨ç½²"
            
            # å¦‚æžœæœ‰ Vercel Deploy Hookï¼Œè§¦å‘éƒ¨ç½²
            if [ ! -z "$VERCEL_DEPLOY_HOOK_URL" ]; then
              echo "ðŸš€ è§¦å‘ Vercel é‡æ–°éƒ¨ç½²..."
              curl -X POST $VERCEL_DEPLOY_HOOK_URL
            fi
          fi
        else
          echo "âš ï¸ music æ–‡ä»¶å¤¹ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
        fi
        
    - name: ðŸ“Š åŒæ­¥æŠ¥å‘Š
      run: |
        echo "## ðŸ“‹ åŒæ­¥å®ŒæˆæŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "- â° åŒæ­¥æ—¶é—´: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ åŒæ­¥å†…å®¹: music æ–‡ä»¶å¤¹" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ Vercel åœ°å€: https://cdn4blog.vercel.app" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ æäº¤ä¿¡æ¯: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY