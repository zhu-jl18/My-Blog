<script>
(function() {
  const STORAGE_KEY = 'theme';

  function getPreferredTheme() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved === 'light' || saved === 'dark') return saved;
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
  }

  function updateToggleIcon(btn) {
    if (!btn) return;
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const icon = btn.querySelector('i');
    if (icon) {
      // 检查是否在菜单中（有文字）
      const hasText = btn.textContent && btn.textContent.includes('主题');
      if (hasText) {
        icon.className = isDark ? 'fa fa-sun fa-fw' : 'fa fa-moon fa-fw';
        btn.innerHTML = `<i class="${icon.className}"></i>${isDark ? '浅色' : '深色'}`;
      } else {
        icon.className = isDark ? 'fa fa-sun fa-fw fa-lg' : 'fa fa-moon fa-fw fa-lg';
      }
    }
    btn.setAttribute('aria-label', isDark ? '切换为浅色' : '切换为深色');
    btn.title = isDark ? '切换为浅色' : '切换为深色';
  }

  function ensureThemeToggle() {
    console.log('ensureThemeToggle called');

    // 1) 顶部右侧容器（若存在）
    const rightContainer = document.querySelector('.site-nav-right');
    console.log('site-nav-right container:', rightContainer);
    if (rightContainer) {
      let rightBtn = rightContainer.querySelector('.theme-toggle');
      if (!rightBtn) {
        console.log('Creating theme toggle button in site-nav-right');
        rightBtn = document.createElement('div');
        rightBtn.className = 'toggle theme-toggle';
        rightBtn.setAttribute('role', 'button');
        rightBtn.innerHTML = '<i class="fa fa-moon fa-fw fa-lg"></i>';
        rightBtn.addEventListener('click', () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
          updateToggleIcon(rightBtn);
        });
        rightContainer.appendChild(rightBtn);
        console.log('Theme toggle button added to site-nav-right');
      }
      updateToggleIcon(rightBtn);
    }

    // 2) 主导航菜单中也添加一个（保证可见）
    const mainMenu = document.querySelector('.main-menu.menu');
    console.log('main-menu container:', mainMenu);
    if (mainMenu) {
      let existingItem = mainMenu.querySelector('.menu-item-theme-toggle');
      if (!existingItem) {
        console.log('Creating theme toggle in main menu');
        const li = document.createElement('li');
        li.className = 'menu-item menu-item-theme-toggle';
        const menuBtn = document.createElement('a');
        menuBtn.setAttribute('role', 'button');
        menuBtn.className = 'theme-toggle';
        menuBtn.innerHTML = '<i class="fa fa-moon fa-fw"></i>深色';
        menuBtn.addEventListener('click', (e) => {
          e.preventDefault();
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
          updateToggleIcon(menuBtn);
        });
        li.appendChild(menuBtn);
        mainMenu.appendChild(li);
        updateToggleIcon(menuBtn);
        console.log('Theme toggle button added to main menu');
      }
    }
  }

  // 初始化
  applyTheme(getPreferredTheme());
  ensureThemeToggle();

  // 跟随系统变化（仅当没有显式选择时）
  const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  if (media && media.addEventListener) {
    media.addEventListener('change', () => {
      if (!localStorage.getItem(STORAGE_KEY)) {
        applyTheme(getPreferredTheme());
        updateToggleIcon(document.querySelector('.theme-toggle'));
      }
    });
  }

  // 悬浮按钮：位置选项 left-bottom | left-middle | top-left
  const FLOAT_POS = 'left-bottom';

  function ensureFloatingToggle() {
    // 移除旧的
    let floatBtn = document.querySelector('.theme-floating-toggle');
    if (floatBtn) floatBtn.remove();

    // 创建新的
    floatBtn = document.createElement('div');
    floatBtn.className = `theme-floating-toggle pos-${FLOAT_POS}`;
    floatBtn.setAttribute('role', 'button');
    floatBtn.innerHTML = '<i class="fa fa-moon fa-fw"></i>';
    floatBtn.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const next = isDark ? 'light' : 'dark';
      localStorage.setItem(STORAGE_KEY, next);
      applyTheme(next);
      updateToggleIcon(floatBtn);
    });
    document.body.appendChild(floatBtn);
    updateToggleIcon(floatBtn);
  }

  // 不再把按钮插入导航；如存在旧按钮则移除
  function cleanupNavToggles() {
    document.querySelectorAll('.site-nav-right .theme-toggle, .main-menu .menu-item-theme-toggle').forEach(el => el.remove());
  }

  // 初始化
  applyTheme(getPreferredTheme());
  cleanupNavToggles();
  ensureFloatingToggle();

  // 跟随系统变化（仅当没有显式选择时）
  const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  if (media && media.addEventListener) {
    media.addEventListener('change', () => {
      if (!localStorage.getItem(STORAGE_KEY)) {
        applyTheme(getPreferredTheme());
        updateToggleIcon(document.querySelector('.theme-floating-toggle'));
      }
    });
  }

  // PJAX 页面切换后重新挂载按钮
  document.addEventListener('pjax:success', () => {
    cleanupNavToggles();
    ensureFloatingToggle();
  });
})();
</script>
