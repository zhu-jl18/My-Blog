<script>
(function() {
  const STORAGE_KEY = 'theme';

  function getPreferredTheme() {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved === 'light' || saved === 'dark') return saved;
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
  }

  function applyTheme(theme) {
    if (theme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
    } else {
      document.documentElement.removeAttribute('data-theme');
    }
  }

  function updateToggleIcon(btn) {
    if (!btn) return;
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const icon = btn.querySelector('i');
    if (icon) {
      // 检查是否在菜单中（有文字）
      const hasText = btn.textContent && btn.textContent.includes('主题');
      if (hasText) {
        icon.className = isDark ? 'fa fa-sun fa-fw' : 'fa fa-moon fa-fw';
        btn.innerHTML = `<i class="${icon.className}"></i>${isDark ? '浅色' : '深色'}`;
      } else {
        icon.className = isDark ? 'fa fa-sun fa-fw fa-lg' : 'fa fa-moon fa-fw fa-lg';
      }
    }
    btn.setAttribute('aria-label', isDark ? '切换为浅色' : '切换为深色');
    btn.title = isDark ? '切换为浅色' : '切换为深色';
  }

  function ensureThemeToggle() {
    console.log('ensureThemeToggle called'); // 调试日志

    // 优先在 .site-nav-right 中添加
    const container = document.querySelector('.site-nav-right');
    console.log('site-nav-right container:', container); // 调试日志

    if (container) {
      let btn = container.querySelector('.theme-toggle');
      if (!btn) {
        console.log('Creating theme toggle button in site-nav-right'); // 调试日志
        btn = document.createElement('div');
        btn.className = 'toggle theme-toggle';
        btn.setAttribute('role', 'button');
        btn.innerHTML = '<i class="fa fa-moon fa-fw fa-lg"></i>';
        btn.addEventListener('click', () => {
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
          updateToggleIcon(btn);
        });
        // 放在搜索按钮右侧
        container.appendChild(btn);
        console.log('Theme toggle button added to site-nav-right'); // 调试日志
      }
      updateToggleIcon(btn);
      return;
    }

    // 备选方案：在主导航菜单中添加
    const mainMenu = document.querySelector('.main-menu.menu');
    console.log('main-menu container:', mainMenu); // 调试日志

    if (mainMenu) {
      let existingItem = mainMenu.querySelector('.menu-item-theme-toggle');
      if (!existingItem) {
        console.log('Creating theme toggle in main menu'); // 调试日志
        const li = document.createElement('li');
        li.className = 'menu-item menu-item-theme-toggle';
        const btn = document.createElement('a');
        btn.setAttribute('role', 'button');
        btn.className = 'theme-toggle';
        btn.innerHTML = '<i class="fa fa-moon fa-fw"></i>深色';
        btn.addEventListener('click', (e) => {
          e.preventDefault();
          const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
          const next = isDark ? 'light' : 'dark';
          localStorage.setItem(STORAGE_KEY, next);
          applyTheme(next);
          updateToggleIcon(btn);
        });
        li.appendChild(btn);
        mainMenu.appendChild(li);
        updateToggleIcon(btn);
        console.log('Theme toggle button added to main menu'); // 调试日志
      }
    }
  }

  // 初始化
  applyTheme(getPreferredTheme());
  ensureThemeToggle();

  // 跟随系统变化（仅当没有显式选择时）
  const media = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)');
  if (media && media.addEventListener) {
    media.addEventListener('change', () => {
      if (!localStorage.getItem(STORAGE_KEY)) {
        applyTheme(getPreferredTheme());
        updateToggleIcon(document.querySelector('.theme-toggle'));
      }
    });
  }

  // PJAX 页面切换后重新挂载按钮
  document.addEventListener('pjax:success', () => {
    ensureThemeToggle();
  });
})();
</script>
